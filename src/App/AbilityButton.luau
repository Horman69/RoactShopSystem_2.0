--!strict
-- src/App/AbilityButton.luau
-- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –∫–Ω–æ–ø–∫–∞ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Å –∫—É–ª–¥–∞—É–Ω–æ–º –∏ –∞–Ω–∏–º–∞—Ü–∏—è–º–∏
-- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∏–ª—é –ø—Ä–æ–µ–∫—Ç–∞

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")

-- –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
local ModuleLoader = require(ReplicatedStorage:WaitForChild("shared"):WaitForChild("ModuleLoader"))
local Roact = ModuleLoader.require("Packages/roact")
local PlatformService = ModuleLoader.require("services/PlatformService")

-- –¢–∏–ø—ã –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
local Types = require(ReplicatedStorage:WaitForChild("shared"):WaitForChild("Types"))
local ShopConfig = require(ReplicatedStorage:WaitForChild("shared"):WaitForChild("ShopConfig"))
type Ability = Types.Ability

-- –ü—Ä–æ–ø—Å—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
type AbilityButtonProps = {
	ability: Ability,
	isOwned: boolean,
	isOnCooldown: boolean,
	cooldownTimeLeft: number?,
	isActive: boolean?, -- –ï—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
	onActivate: (abilityId: string) -> (),
	onPurchase: ((ability: Ability) -> ())?,
	position: UDim2?,
	size: UDim2?,
}

-- –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–≤–∏–Ω–∞—Ö
local TWEEN_INFO = {
	HOVER = TweenInfo.new(ShopConfig.design.animations.duration, ShopConfig.design.animations.easing),
	PRESS = TweenInfo.new(0.1, ShopConfig.design.animations.easing),
	COOLDOWN = TweenInfo.new(0.3, ShopConfig.design.animations.easing),
}

local AbilityButton = Roact.Component:extend("AbilityButton")

function AbilityButton:init()
	self:setState({
		isHovering = false,
		isPressing = false,
	})
	
	-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º PlatformService
	self.platformService = PlatformService.new()
end

function AbilityButton:render()
	local props = self.props
	local state = self.state
	local ability = props.ability
	
	-- –ü–æ–ª—É—á–∞–µ–º –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
	local isMobile = self.platformService:isMobile()
	local scaleFactor = self.platformService:getScaleFactor()
	
	-- –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
	local isDisabled = props.isOnCooldown or not props.isOwned
	local isActive = props.isActive or false
	
	-- –í—ã–±–∏—Ä–∞–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
	local backgroundColor = ShopConfig.design.colors.button.primary
	local textColor = ShopConfig.design.colors.text.button
	
	if not props.isOwned then
		backgroundColor = ShopConfig.design.colors.button.disabled
		textColor = ShopConfig.design.colors.text.secondary
	elseif props.isOnCooldown then
		backgroundColor = ShopConfig.design.colors.button.disabled
		textColor = ShopConfig.design.colors.text.disabled
	elseif isActive then
		backgroundColor = ShopConfig.design.colors.button.success
		textColor = ShopConfig.design.colors.text.button
	elseif state.isHovering and props.isOwned and not props.isOnCooldown then
		backgroundColor = Color3.new(
			math.min(1, ShopConfig.design.colors.button.primary.R * 1.1),
			math.min(1, ShopConfig.design.colors.button.primary.G * 1.1),
			math.min(1, ShopConfig.design.colors.button.primary.B * 1.1)
		)
	end
	
	-- –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
	local buttonText = ability.icon and (ability.icon .. " " .. ability.name) or ability.name
	local statusText = ""
	
	if not props.isOwned then
		statusText = string.format("üí∞ %d –º–æ–Ω–µ—Ç", ability.price)
	elseif props.isOnCooldown and props.cooldownTimeLeft then
		statusText = string.format("‚è∞ %.1f —Å–µ–∫", props.cooldownTimeLeft)
	elseif isActive then
		statusText = "‚ú® –ê–∫—Ç–∏–≤–Ω–æ"
	end
	
	return Roact.createElement("TextButton", {
		Size = props.size or UDim2.new(0, isMobile and 280 or 200, 0, isMobile and 100 or 80),
		Position = props.position or UDim2.new(0, 0, 0, 0),
		BackgroundColor3 = backgroundColor,
		BorderSizePixel = 0,
		Text = "",
		AutoButtonColor = false,
		Modal = true, -- –î–û–ë–ê–í–õ–ï–ù–û: –æ—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∑–≤—É–∫–∏ Roblox
		
		-- –°–æ–±—ã—Ç–∏—è –º—ã—à–∏
		[Roact.Event.MouseEnter] = function()
			self:setState({ isHovering = true })
		end,
		
		[Roact.Event.MouseLeave] = function()
			self:setState({ isHovering = false, isPressing = false })
		end,
		
		[Roact.Event.MouseButton1Down] = function()
			if not isDisabled then
				self:setState({ isPressing = true })
			end
		end,
		
		[Roact.Event.MouseButton1Up] = function()
			self:setState({ isPressing = false })
		end,
		
		[Roact.Event.MouseButton1Click] = function()
			if not isDisabled then
				if props.isOwned then
					props.onActivate(ability.id)
				elseif props.onPurchase then
					props.onPurchase(ability)
				end
			end
		end,
		
		-- Touch events –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
		[Roact.Event.TouchTap] = function()
			if not isDisabled then
				if props.isOwned then
					props.onActivate(ability.id)
				elseif props.onPurchase then
					props.onPurchase(ability)
				end
			end
		end,
	}, {
		-- –°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ
		UICorner = Roact.createElement("UICorner", {
			CornerRadius = UDim.new(0, ShopConfig.design.borderRadius.button),
		}),
		
		-- –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç (–¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π)
		UIGradient = isActive and Roact.createElement("UIGradient", {
			Color = ColorSequence.new({
				ColorSequenceKeypoint.new(0, ShopConfig.design.colors.button.success),
				ColorSequenceKeypoint.new(1, Color3.fromRGB(
					math.max(0, ShopConfig.design.colors.button.success.R * 255 - 30) / 255,
					math.max(0, ShopConfig.design.colors.button.success.G * 255 - 30) / 255,
					math.max(0, ShopConfig.design.colors.button.success.B * 255 - 30) / 255
				)),
			}),
			Rotation = 45,
		}) or nil,
		
		-- –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
		NameLabel = Roact.createElement("TextLabel", {
			Size = UDim2.new(1, -20, 0, isMobile and 36 or 32),
			Position = UDim2.new(0, 10, 0, isMobile and 10 or 8),
			BackgroundTransparency = 1,
			Text = buttonText,
			TextColor3 = textColor,
			TextSize = isMobile and 20 or 18,
			Font = ShopConfig.design.colors.text.fonts.bold,
			TextXAlignment = Enum.TextXAlignment.Left,
			TextYAlignment = Enum.TextYAlignment.Center,
		}),
		
		-- –°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
		DescriptionLabel = Roact.createElement("TextLabel", {
			Size = UDim2.new(1, -20, 0, isMobile and 24 or 20),
			Position = UDim2.new(0, 10, 0, isMobile and 42 or 35),
			BackgroundTransparency = 1,
			Text = ability.description,
			TextColor3 = ShopConfig.design.colors.text.secondary,
			TextSize = isMobile and 14 or 12,
			Font = ShopConfig.design.colors.text.fonts.regular,
			TextXAlignment = Enum.TextXAlignment.Left,
			TextYAlignment = Enum.TextYAlignment.Top,
			TextWrapped = true,
		}),
		
		-- –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å (—Ü–µ–Ω–∞, –∫—É–ª–¥–∞—É–Ω, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å)
		StatusLabel = statusText ~= "" and Roact.createElement("TextLabel", {
			Size = UDim2.new(1, -20, 0, isMobile and 20 or 16),
			Position = UDim2.new(0, 10, 1, isMobile and -28 or -24),
			BackgroundTransparency = 1,
			Text = statusText,
			TextColor3 = not props.isOwned and ShopConfig.design.colors.text.accent or 
						 props.isOnCooldown and ShopConfig.design.colors.text.disabled or
						 isActive and ShopConfig.design.colors.status.success or
						 textColor,
			TextSize = isMobile and 16 or 14,
			Font = ShopConfig.design.colors.text.fonts.bold,
			TextXAlignment = Enum.TextXAlignment.Right,
			TextYAlignment = Enum.TextYAlignment.Center,
		}) or nil,
		
		-- –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –∫—É–ª–¥–∞—É–Ω–∞
		CooldownBar = props.isOnCooldown and props.cooldownTimeLeft and Roact.createElement("Frame", {
			Size = UDim2.new(1, 0, 0, 3),
			Position = UDim2.new(0, 0, 1, -3),
			BackgroundColor3 = ShopConfig.design.colors.status.error,
			BorderSizePixel = 0,
		}, {
			UICorner = Roact.createElement("UICorner", {
				CornerRadius = UDim.new(0, 2),
			}),
			
			-- –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∫—É–ª–¥–∞—É–Ω–∞
			Progress = Roact.createElement("Frame", {
				Size = UDim2.new(math.max(0, props.cooldownTimeLeft / 8), 0, 1, 0), -- –ü—Ä–∏–º–µ—Ä–Ω—ã–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∫—É–ª–¥–∞—É–Ω 8 —Å–µ–∫
				Position = UDim2.new(0, 0, 0, 0),
				BackgroundColor3 = ShopConfig.design.colors.accent.primary,
				BorderSizePixel = 0,
			}, {
				UICorner = Roact.createElement("UICorner", {
					CornerRadius = UDim.new(0, 2),
				}),
			}),
		}) or nil,
		
		-- –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç —Å–≤–µ—á–µ–Ω–∏—è –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π
		GlowEffect = isActive and Roact.createElement("Frame", {
			Size = UDim2.new(1, 4, 1, 4),
			Position = UDim2.new(0, -2, 0, -2),
			BackgroundTransparency = 1,
			BorderSizePixel = 0,
			ZIndex = -1,
		}, {
			UICorner = Roact.createElement("UICorner", {
				CornerRadius = UDim.new(0, ShopConfig.design.borderRadius.button + 2),
			}),
			
			UIStroke = Roact.createElement("UIStroke", {
				Color = ShopConfig.design.colors.accent.primary,
				Thickness = ShopConfig.design.stroke.thickness,
				Transparency = 0.3,
			}),
		}) or nil,
	})
end

return AbilityButton

