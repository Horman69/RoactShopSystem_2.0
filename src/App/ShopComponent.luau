--!strict
-- src/App/ShopComponent.luau
-- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç Roact –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞ –∏ –ø–æ–∫—É–ø–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
-- –û–±–Ω–æ–≤–ª—ë–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–æ–≤–æ–π —Å–µ—Ä–≤–∏—Å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π

local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ ModuleLoader
local ModuleLoader = require(ReplicatedStorage:WaitForChild("shared"):WaitForChild("ModuleLoader"))
local Roact = ModuleLoader.require("Packages/roact")
local ShopService = ModuleLoader.require("services/ShopService")

-- –¢–∏–ø—ã
local Types = require(ReplicatedStorage:WaitForChild("shared"):WaitForChild("Types"))
type Product = Types.Product
type ShopComponentProps = Types.ShopComponentProps

--[=[
	ShopComponent
	–ü—Ä–æ–ø—Å—ã:
	- onPurchase (function): —Ñ—É–Ω–∫—Ü–∏—è, –≤—ã–∑—ã–≤–∞–µ–º–∞—è –ø–æ—Å–ª–µ –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–∫—É–ø–∫–∏
	- currentCoins (number): —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
]=]
local ShopComponent = Roact.Component:extend("ShopComponent")

function ShopComponent:init()
	-- –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
	self.shopService = self.props.shopService or ShopService.new()
	
	-- –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
	self:updateProducts()
end

-- –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
function ShopComponent:updateProducts()
	local Players = game:GetService("Players")
	local player = Players.LocalPlayer
	local availableProducts = self.shopService:getAvailableProducts(player)
	self:setState({
		products = availableProducts
	})
end

-- –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–æ–ø—Å–æ–≤
function ShopComponent:didUpdate(previousProps)
	-- –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è updateTrigger, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
	if self.props.updateTrigger ~= previousProps.updateTrigger then
		self:updateProducts()
	end
end

function ShopComponent:render()
	local products = self.state.products or {}
	local productElements = {}
	
	-- –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –º–µ–∂–¥—É –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ (–±—ã–ª–æ 80, —Å—Ç–∞–ª–æ 100)
	local cardHeight = 80
	local cardSpacing = 20 -- –æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏
	local totalItemHeight = cardHeight + cardSpacing
	
	for i, product in ipairs(products) do
		productElements["Product" .. i] = Roact.createElement("Frame", {
			Size = UDim2.new(0, 350, 0, cardHeight),
			Position = UDim2.new(0, 20, 0, totalItemHeight * (i - 1) + 10), -- –¥–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É
			BackgroundColor3 = Color3.fromRGB(45, 45, 50), -- —á—É—Ç—å —Å–≤–µ—Ç–ª–µ–µ –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞
			BorderSizePixel = 0,
		}, {
			-- –°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ
			UICorner = Roact.createElement("UICorner", {
				CornerRadius = UDim.new(0, 12),
			}),
			
			-- –¢–µ–Ω—å –∫–∞—Ä—Ç–æ—á–∫–∏
			Shadow = Roact.createElement("Frame", {
				BackgroundColor3 = Color3.fromRGB(0, 0, 0),
				BackgroundTransparency = 0.7,
				BorderSizePixel = 0,
				Size = UDim2.new(1, 4, 1, 4),
				Position = UDim2.new(0, -2, 0, 3),
				ZIndex = -1,
			}, {
				UICorner = Roact.createElement("UICorner", {
					CornerRadius = UDim.new(0, 12),
				}),
			}),
			
			-- –¢–æ–Ω–∫–∞—è —Ä–∞–º–∫–∞
			Border = Roact.createElement("UIStroke", {
				Color = Color3.fromRGB(70, 70, 70),
				Thickness = 1,
				Transparency = 0.3,
			}),
			
			-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ
			ProductInfo = Roact.createElement("Frame", {
				Size = UDim2.new(0, 220, 1, 0),
				BackgroundTransparency = 1,
			}, {
				Name = Roact.createElement("TextLabel", {
					Text = product.name,
					Size = UDim2.new(1, 0, 0, 25),
					Position = UDim2.new(0, 15, 0, 8),
					BackgroundTransparency = 1,
					TextXAlignment = Enum.TextXAlignment.Left,
					TextSize = 20,
					Font = Enum.Font.GothamBold,
					TextColor3 = Color3.fromRGB(255, 255, 255),
				}),
				Price = Roact.createElement("TextLabel", {
					Text = "üí∞ " .. product.price .. " –º–æ–Ω–µ—Ç",
					Size = UDim2.new(1, 0, 0, 20),
					Position = UDim2.new(0, 15, 0, 33),
					BackgroundTransparency = 1,
					TextXAlignment = Enum.TextXAlignment.Left,
					TextSize = 16,
					Font = Enum.Font.GothamBold,
					TextColor3 = Color3.fromRGB(255, 215, 0),
				}),
				Description = Roact.createElement("TextLabel", {
					Text = product.description,
					Size = UDim2.new(1, 0, 0, 20),
					Position = UDim2.new(0, 15, 0, 53),
					BackgroundTransparency = 1,
					TextXAlignment = Enum.TextXAlignment.Left,
					TextSize = 14,
					Font = Enum.Font.Gotham,
					TextColor3 = Color3.fromRGB(200, 200, 200),
					TextWrapped = true,
				}),
			}),
			
			-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∫—É–ø–∫–∏ —Å –ø—Ä–æ—Å—Ç–æ–π –∞–Ω–∏–º–∞—Ü–∏–µ–π
			BuyButton = Roact.createElement("TextButton", {
				Text = "–ö—É–ø–∏—Ç—å",
				Size = UDim2.new(0, 100, 0, 40),
				Position = UDim2.new(0, 235, 0, 20),
				BackgroundColor3 = Color3.fromRGB(0, 170, 255),
				TextSize = 18,
				Font = Enum.Font.GothamBlack,
				TextColor3 = Color3.fromRGB(255, 255, 255),
				AutoButtonColor = false,
				[Roact.Event.Activated] = function()
					-- –í—ã–∑—ã–≤–∞–µ–º –∫–æ–ª–±—ç–∫ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
					if self.props.onPurchase then
						self.props.onPurchase(product)
					end
				end,
			}, {
				UICorner = Roact.createElement("UICorner", {
					CornerRadius = UDim.new(0, 8),
				}),
			}),
		})
	end

	-- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â—É—é –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞
	local totalContentHeight = totalItemHeight * #products + 20
	
	-- –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ã—á–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω
	return Roact.createElement("Frame", {
		Size = UDim2.new(0, 400, 0, math.min(420, totalContentHeight + 40)),
		Position = UDim2.new(0, 0, 0, 120),
		BackgroundColor3 = Color3.fromRGB(28, 28, 30), -- –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π –∫–∞–∫ —É AbilityPanel
		BackgroundTransparency = 0.05, -- –ü–æ—á—Ç–∏ –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π
		BorderSizePixel = 0,
		Visible = self.props.visible,
	}, {
		-- –°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ
		UICorner = Roact.createElement("UICorner", {
			CornerRadius = UDim.new(0, 16),
		}),
		
		-- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ç–µ–Ω—å –ø–∞–Ω–µ–ª–∏
		Shadow = Roact.createElement("Frame", {
			BackgroundColor3 = Color3.fromRGB(0, 0, 0),
			BackgroundTransparency = 0.8,
			BorderSizePixel = 0,
			Size = UDim2.new(1, 6, 1, 6),
			Position = UDim2.new(0, -3, 0, 3),
			ZIndex = -1,
		}, {
			UICorner = Roact.createElement("UICorner", {
				CornerRadius = UDim.new(0, 19),
			}),
		}),
		
		-- –¢–æ–Ω–∫–∞—è —Ä–∞–º–∫–∞ –ø–∞–Ω–µ–ª–∏
		Border = Roact.createElement("UIStroke", {
			Color = Color3.fromRGB(60, 60, 60),
			Thickness = 1,
			Transparency = 0.5,
		}),
		
		-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –º–∞–≥–∞–∑–∏–Ω–∞
		Header = Roact.createElement("TextLabel", {
			Text = "üõí –ú–∞–≥–∞–∑–∏–Ω —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π",
			Size = UDim2.new(1, -60, 0, 30), -- –£–º–µ–Ω—å—à–∏–ª–∏ —à–∏—Ä–∏–Ω—É, —á—Ç–æ–±—ã –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –º–µ—Å—Ç–æ –¥–ª—è –∫–Ω–æ–ø–∫–∏
			Position = UDim2.new(0, 10, 0, 10),
			BackgroundTransparency = 1,
			TextXAlignment = Enum.TextXAlignment.Center,
			TextSize = 20,
			Font = Enum.Font.GothamBold,
			TextColor3 = Color3.fromRGB(255, 255, 255),
		}),
		
		-- –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è (–∫—Ä–µ—Å—Ç–∏–∫)
		CloseButton = Roact.createElement("TextButton", {
			Text = "‚úï",
			Size = UDim2.new(0, 30, 0, 30),
			Position = UDim2.new(1, -40, 0, 10), -- –ü—Ä–∞–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª
			BackgroundColor3 = Color3.fromRGB(200, 60, 60), -- –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç
			TextSize = 18,
			Font = Enum.Font.GothamBold,
			TextColor3 = Color3.fromRGB(255, 255, 255),
			AutoButtonColor = false,
			[Roact.Event.Activated] = function()
				-- –í—ã–∑—ã–≤–∞–µ–º –∫–æ–ª–±—ç–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–∞–≥–∞–∑–∏–Ω–∞
				if self.props.onClose then
					self.props.onClose()
				end
			end,
		}, {
			UICorner = Roact.createElement("UICorner", {
				CornerRadius = UDim.new(0, 6),
			}),
			-- –¢–µ–Ω—å –¥–ª—è –∫–Ω–æ–ø–∫–∏
			ButtonShadow = Roact.createElement("Frame", {
				BackgroundColor3 = Color3.fromRGB(0, 0, 0),
				BackgroundTransparency = 0.7,
				BorderSizePixel = 0,
				Size = UDim2.new(1, 2, 1, 2),
				Position = UDim2.new(0, -1, 0, 2),
				ZIndex = -1,
			}, {
				UICorner = Roact.createElement("UICorner", {
					CornerRadius = UDim.new(0, 6),
				}),
			}),
		}),
		
		-- –°–∫—Ä–æ–ª–ª–∏—Ä—É–µ–º—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–æ–≤–∞—Ä–æ–≤
		ProductsList = Roact.createElement("ScrollingFrame", {
			Size = UDim2.new(1, -20, 1, -60),
			Position = UDim2.new(0, 10, 0, 50),
			BackgroundTransparency = 1,
			BorderSizePixel = 0,
			CanvasSize = UDim2.new(0, 0, 0, totalContentHeight),
			ScrollBarThickness = 8,
			ScrollBarImageColor3 = Color3.fromRGB(100, 100, 100),
		}, productElements)
	})
end

return ShopComponent
