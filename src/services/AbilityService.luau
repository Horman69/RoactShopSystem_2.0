--!strict
-- src/services/AbilityService.luau
-- –°–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è–º–∏ –∏–≥—Ä–æ–∫–æ–≤
-- –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—é, –∫—É–ª–¥–∞—É–Ω—ã, –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –∏ –ø—Ä–µ–º–∏—É–º –±—É—Å—Ç—ã

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

-- –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ ModuleLoader
local ModuleLoader = require(ReplicatedStorage:WaitForChild("shared"):WaitForChild("ModuleLoader"))
local AbilityConfig = ModuleLoader.require("shared/AbilityConfig")
local SpecialAbilityConfig = ModuleLoader.require("shared/SpecialAbilityConfig")

-- –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–∏–ø—ã –Ω–∞–ø—Ä—è–º—É—é
local Types = require(ReplicatedStorage:WaitForChild("shared"):WaitForChild("Types"))
type Ability = Types.Ability
type AbilityList = Types.AbilityList
type PlayerAbilityState = Types.PlayerAbilityState
type ActiveEffect = Types.ActiveEffect
type AbilityActivationResult = Types.AbilityActivationResult

-- –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º PlayerStatsService (–±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏)
local PlayerStatsService

-- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–µ—Ä–≤–∏—Å–∞ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π
type AbilityServiceInterface = {
	-- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã
	activateAbility: (self: AbilityServiceInterface, player: Player, abilityId: string) -> AbilityActivationResult,
	getPlayerAbilities: (self: AbilityServiceInterface, player: Player) -> AbilityList,
	getPlayerState: (self: AbilityServiceInterface, player: Player) -> PlayerAbilityState,
	
	-- –ü—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
	isAbilityOwned: (self: AbilityServiceInterface, player: Player, abilityId: string) -> boolean,
	isAbilityOnCooldown: (self: AbilityServiceInterface, player: Player, abilityId: string) -> boolean,
	getCooldownTimeLeft: (self: AbilityServiceInterface, player: Player, abilityId: string) -> number,
	
	-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è–º–∏
	grantAbility: (self: AbilityServiceInterface, player: Player, abilityId: string) -> boolean,
	removeAbility: (self: AbilityServiceInterface, player: Player, abilityId: string) -> boolean,
	
	-- –≠—Ñ—Ñ–µ–∫—Ç—ã
	getActiveEffects: (self: AbilityServiceInterface, player: Player) -> {[string]: ActiveEffect},
	clearExpiredEffects: (self: AbilityServiceInterface, player: Player) -> (),
	removeAllEffects: (self: AbilityServiceInterface, player: Player) -> (),
	
	-- –°–æ–±—ã—Ç–∏—è
	onAbilityActivated: (self: AbilityServiceInterface, callback: (player: Player, ability: Ability) -> ()) -> (),
	onEffectExpired: (self: AbilityServiceInterface, callback: (player: Player, abilityId: string) -> ()) -> (),
	
	-- –£—Ç–∏–ª–∏—Ç—ã
	getEffectiveDuration: (self: AbilityServiceInterface, player: Player, abilityId: string) -> number,
	isPremiumPlayer: (self: AbilityServiceInterface, player: Player) -> boolean,
}

local AbilityService = {} :: AbilityServiceInterface
AbilityService.__index = AbilityService

-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤
local playerStates: {[Player]: PlayerAbilityState} = {}

-- –ö–æ–ª–±—ç–∫–∏ –¥–ª—è —Å–æ–±—ã—Ç–∏–π
local abilityActivatedCallbacks: {(player: Player, ability: Ability) -> ()} = {}
local effectExpiredCallbacks: {(player: Player, abilityId: string) -> ()} = {}

-- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
local CONFIG = {
	PREMIUM_DURATION_MULTIPLIER = 2, -- –ü—Ä–µ–º–∏—É–º –∏–≥—Ä–æ–∫–∏ –ø–æ–ª—É—á–∞—é—Ç x2 –∫ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
	MAX_ACTIVE_EFFECTS = 10, -- –ú–∞–∫—Å–∏–º—É–º –∞–∫—Ç–∏–≤–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –Ω–∞ –∏–≥—Ä–æ–∫–∞
	EFFECT_UPDATE_INTERVAL = 0.1, -- –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (–±–æ–ª–µ–µ —á–∞—Å—Ç—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏)
}

-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞
function AbilityService.new(): AbilityServiceInterface
	local self = setmetatable({}, AbilityService)
	
	-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º PlayerStatsService
	PlayerStatsService = ModuleLoader.require("services/PlayerStatsService").new()
	
	-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º SoundService
	local SimpleSoundService = ModuleLoader.require("services/SimpleSoundService")
	self.soundService = SimpleSoundService.new()
	
	-- –ó–∞–ø—É—Å–∫–∞–µ–º —Ü–∏–∫–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
	self:_startEffectUpdateLoop()
	
	-- –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è –∏–≥—Ä–æ–∫–æ–≤
	Players.PlayerAdded:Connect(function(player)
		self:_initializePlayerState(player)
	end)
	
	Players.PlayerRemoving:Connect(function(player)
		self:_cleanupPlayerState(player)
	end)
	
	-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
	for _, player in ipairs(Players:GetPlayers()) do
		self:_initializePlayerState(player)
	end
	
	print("AbilityService: –°–µ—Ä–≤–∏—Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
	return self
end

-- –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
function AbilityService:activateAbility(player: Player, abilityId: string): AbilityActivationResult
	print("AbilityService: –ü–æ–ø—ã—Ç–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏", abilityId, "–∏–≥—Ä–æ–∫–æ–º", player.Name)
	
	-- –ü–æ–ª—É—á–∞–µ–º —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å (–∏—â–µ–º –≤ –±–∞–∑–æ–≤—ã—Ö –∏ –æ—Å–æ–±—ã—Ö)
	local ability = AbilityConfig.getAbilityById(abilityId)
	if not ability then
		ability = SpecialAbilityConfig.getSpecialAbilityById(abilityId)
	end
	
	if not ability then
		print("AbilityService: –°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å", abilityId, "–Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
		return {
			success = false,
			message = "–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞",
			ability = nil,
			cooldownEnd = nil,
		}
	end
	
	print("AbilityService: –°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –Ω–∞–π–¥–µ–Ω–∞:", ability.name)
	
	-- –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–æ–∫ –≤–ª–∞–¥–µ–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å—é
	if not self:isAbilityOwned(player, abilityId) then
		print("AbilityService: –ò–≥—Ä–æ–∫", player.Name, "–Ω–µ –≤–ª–∞–¥–µ–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å—é", abilityId)
		
		-- –ó–≤—É–∫ –æ—à–∏–±–∫–∏ - —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –Ω–µ –∫—É–ø–ª–µ–Ω–∞
		if self.soundService then
			self.soundService:playAbilityCooldown()
		end
		
		return {
			success = false,
			message = "–£ –≤–∞—Å –Ω–µ—Ç —ç—Ç–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏",
			ability = ability,
			cooldownEnd = nil,
		}
	end
	
	print("AbilityService: –ò–≥—Ä–æ–∫ –≤–ª–∞–¥–µ–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å—é")
	
	-- –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—É–ª–¥–∞—É–Ω
	if self:isAbilityOnCooldown(player, abilityId) then
		local timeLeft = self:getCooldownTimeLeft(player, abilityId)
		print("AbilityService: –°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –Ω–∞ –∫—É–ª–¥–∞—É–Ω–µ, –æ—Å—Ç–∞–ª–æ—Å—å", timeLeft, "—Å–µ–∫")
		
		-- –ó–≤—É–∫ –∫—É–ª–¥–∞—É–Ω–∞
		if self.soundService then
			self.soundService:playAbilityCooldown()
		end
		
		return {
			success = false,
			message = string.format("–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –Ω–∞ –∫—É–ª–¥–∞—É–Ω–µ (%.1f —Å–µ–∫)", timeLeft),
			ability = ability,
			cooldownEnd = tick() + timeLeft,
		}
	end
	
	print("AbilityService: –ö—É–ª–¥–∞—É–Ω –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω")
	
	-- –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
	local activeEffects = self:getActiveEffects(player)
	if #activeEffects >= CONFIG.MAX_ACTIVE_EFFECTS then
		print("AbilityService: –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤:", #activeEffects)
		return {
			success = false,
			message = "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤",
			ability = ability,
			cooldownEnd = nil,
		}
	end
	
	print("AbilityService: –õ–∏–º–∏—Ç —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –≤ –Ω–æ—Ä–º–µ")
	
	-- –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
	local duration = self:getEffectiveDuration(player, abilityId)
	local currentTime = tick()
	
	print("AbilityService: –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é", duration, "—Å–µ–∫")
	
	-- –°–æ–∑–¥–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
	local activeEffect: ActiveEffect = {
		abilityId = abilityId,
		startTime = currentTime,
		duration = duration,
		effects = ability.effects,
	}
	
	-- –î–æ–±–∞–≤–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç –∫ –∏–≥—Ä–æ–∫—É
	local playerState = self:getPlayerState(player)
	playerState.activeEffects[abilityId] = activeEffect
	
	-- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—É–ª–¥–∞—É–Ω –ü–û–°–õ–ï –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
	-- –ö—É–ª–¥–∞—É–Ω = –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∞ + –≤—Ä–µ–º—è –∫—É–ª–¥–∞—É–Ω–∞
	playerState.cooldowns[abilityId] = currentTime + duration + ability.cooldown
	
	print("AbilityService: –≠—Ñ—Ñ–µ–∫—Ç –¥–æ–±–∞–≤–ª–µ–Ω, –ø—Ä–∏–º–µ–Ω—è–µ–º —á–µ—Ä–µ–∑ PlayerStatsService")
	
	-- –ü—Ä–∏–º–µ–Ω—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ PlayerStatsService
	for i, effect in ipairs(ability.effects) do
		print("AbilityService: –ü—Ä–∏–º–µ–Ω—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç", i, ":", effect.type, effect.value, effect.target)
		PlayerStatsService:applyEffect(player, effect, abilityId)
	end
	
	print("üéµ AbilityService: –°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å", ability.name, "–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞", duration, "—Å–µ–∫. –ó–≤—É–∫ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏...")
	
	-- –ó–≤—É–∫ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
	if self.soundService then
		self.soundService:playAbilityActivate()
		
		-- –í–ê–ñ–ù–û: –ó–≤—É–∫ "—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–Ω–æ–≤–∞ –∞–∫—Ç–∏–≤–Ω–∞" –≤—Å–µ–≥–¥–∞ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
		-- (–Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —ç—Ñ—Ñ–µ–∫—Ç–∞)
		spawn(function()
			print("üîä AbilityService: –û–∂–∏–¥–∞–Ω–∏–µ 30 —Å–µ–∫ –¥–ª—è –∑–≤—É–∫–∞ '—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–Ω–æ–≤–∞ –∞–∫—Ç–∏–≤–Ω–∞'...")
			wait(30)
			
			-- –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ "—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–Ω–æ–≤–∞ –∞–∫—Ç–∏–≤–Ω–∞" 
			-- (–æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ –ø—Ä–æ—à–ª–æ 30 —Å–µ–∫ —Å –º–æ–º–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏)
			if self.soundService then
				self.soundService:playAbilityActive()
				print("üîä AbilityService: –ó–≤—É–∫ '—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–Ω–æ–≤–∞ –∞–∫—Ç–∏–≤–Ω–∞' –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω –¥–ª—è", player.Name, "—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å:", abilityId)
			else
				warn("‚ö†Ô∏è AbilityService: soundService –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –∑–≤—É–∫–∞ '—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–Ω–æ–≤–∞ –∞–∫—Ç–∏–≤–Ω–∞'")
			end
		end)
		
		print("üîä AbilityService: –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω –∑–≤—É–∫ '—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–Ω–æ–≤–∞ –∞–∫—Ç–∏–≤–Ω–∞' —á–µ—Ä–µ–∑ 30 —Å–µ–∫ –¥–ª—è", player.Name, "—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å:", abilityId)
	else
		warn("‚ö†Ô∏è AbilityService: soundService –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –∑–≤—É–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏")
	end
	
	-- –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
	self:_notifyAbilityActivated(player, ability)
	
	print("AbilityService: –ò–≥—Ä–æ–∫", player.Name, "–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å", ability.name)
	
	return {
		success = true,
		message = string.format("–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å '%s' –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ %.1f —Å–µ–∫", ability.name, duration),
		ability = ability,
		cooldownEnd = currentTime + duration + ability.cooldown, -- –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –∫—É–ª–¥–∞—É–Ω–∞
	}
end

-- –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π –∏–≥—Ä–æ–∫–∞
function AbilityService:getPlayerAbilities(player: Player): AbilityList
	local playerState = self:getPlayerState(player)
	local abilities: AbilityList = {}
	
	for abilityId, isOwned in pairs(playerState.ownedAbilities) do
		if isOwned then
			-- –ò—â–µ–º —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–Ω–∞—á–∞–ª–∞ –≤ –±–∞–∑–æ–≤—ã—Ö, –ø–æ—Ç–æ–º –≤ –æ—Å–æ–±—ã—Ö
			local ability = AbilityConfig.getAbilityById(abilityId)
			if not ability then
				ability = SpecialAbilityConfig.getSpecialAbilityById(abilityId)
			end
			
			if ability then
				table.insert(abilities, ability)
			end
		end
	end
	
	return abilities
end

-- –ü–æ–ª—É—á–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
function AbilityService:getPlayerState(player: Player): PlayerAbilityState
	if not playerStates[player] then
		self:_initializePlayerState(player)
	end
	return playerStates[player]
end

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –≤–ª–∞–¥–µ–µ—Ç –ª–∏ –∏–≥—Ä–æ–∫ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å—é
function AbilityService:isAbilityOwned(player: Player, abilityId: string): boolean
	local playerState = self:getPlayerState(player)
	return playerState.ownedAbilities[abilityId] == true
end

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–∞ –∫—É–ª–¥–∞—É–Ω–µ –ª–∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
function AbilityService:isAbilityOnCooldown(player: Player, abilityId: string): boolean
	return self:getCooldownTimeLeft(player, abilityId) > 0
end

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –¥–æ–ª–∂–Ω–∞ –ª–∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è –∫–∞–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞—è –≤ UI
function AbilityService:isAbilityUnavailableForUI(player: Player, abilityId: string): boolean
	local timeLeft = self:getUITimeLeft(player, abilityId)
	return timeLeft > 0.1 -- –°—á–∏—Ç–∞–µ–º –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–π —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ—Å—Ç–∞–ª–æ—Å—å –±–æ–ª—å—à–µ 0.1 —Å–µ–∫—É–Ω–¥—ã
end

-- –ü–æ–ª—É—á–∏—Ç—å –≤—Ä–µ–º—è –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∫—É–ª–¥–∞—É–Ω–∞
function AbilityService:getCooldownTimeLeft(player: Player, abilityId: string): number
	local playerState = self:getPlayerState(player)
	local cooldownEnd = playerState.cooldowns[abilityId]
	
	if not cooldownEnd then
		return 0
	end
	
	local timeLeft = cooldownEnd - tick()
	return math.max(0, timeLeft)
end

-- –ü–æ–ª—É—á–∏—Ç—å –≤—Ä–µ–º—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ UI (–≤–∫–ª—é—á–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç + –∫—É–ª–¥–∞—É–Ω)
function AbilityService:getUITimeLeft(player: Player, abilityId: string): number
	local playerState = self:getPlayerState(player)
	local currentTime = tick()
	
	-- –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
	local activeEffect = playerState.activeEffects[abilityId]
	if activeEffect then
		-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ä–µ–º—è –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∞
		local effectTimeLeft = (activeEffect.startTime + activeEffect.duration) - currentTime
		if effectTimeLeft > 0 then
			return effectTimeLeft
		end
	end
	
	-- –ï—Å–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç–∞ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—ã–π –∫—É–ª–¥–∞—É–Ω
	return self:getCooldownTimeLeft(player, abilityId)
end

-- –í—ã–¥–∞—Ç—å —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∏–≥—Ä–æ–∫—É
function AbilityService:grantAbility(player: Player, abilityId: string): boolean
	local ability = AbilityConfig.getAbilityById(abilityId)
	if not ability then
		return false
	end
	
	local playerState = self:getPlayerState(player)
	playerState.ownedAbilities[abilityId] = true
	
	print("AbilityService: –ò–≥—Ä–æ–∫", player.Name, "–ø–æ–ª—É—á–∏–ª —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å", ability.name)
	return true
end

-- –ó–∞–±—Ä–∞—Ç—å —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —É –∏–≥—Ä–æ–∫–∞
function AbilityService:removeAbility(player: Player, abilityId: string): boolean
	local playerState = self:getPlayerState(player)
	
	if not playerState.ownedAbilities[abilityId] then
		return false
	end
	
	-- –£–¥–∞–ª—è–µ–º —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
	playerState.ownedAbilities[abilityId] = false
	
	-- –£–¥–∞–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç, –µ—Å–ª–∏ –µ—Å—Ç—å
	playerState.activeEffects[abilityId] = nil
	
	print("AbilityService: –£ –∏–≥—Ä–æ–∫–∞", player.Name, "–∑–∞–±—Ä–∞–Ω–∞ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å", abilityId)
	return true
end

-- –ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –∏–≥—Ä–æ–∫–∞
function AbilityService:getActiveEffects(player: Player): {[string]: ActiveEffect}
	local playerState = self:getPlayerState(player)
	self:clearExpiredEffects(player) -- –û—á–∏—â–∞–µ–º –∏—Å—Ç–µ–∫—à–∏–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
	return playerState.activeEffects
end

-- –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–µ–∫—à–∏–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
function AbilityService:clearExpiredEffects(player: Player): ()
	local playerState = self:getPlayerState(player)
	local currentTime = tick()
	
	for abilityId, effect in pairs(playerState.activeEffects) do
		if currentTime >= effect.startTime + effect.duration then
			-- –≠—Ñ—Ñ–µ–∫—Ç –∏—Å—Ç–µ–∫
			playerState.activeEffects[abilityId] = nil
			
			-- –£–¥–∞–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã —á–µ—Ä–µ–∑ PlayerStatsService
			if PlayerStatsService then
				PlayerStatsService:removeEffect(player, abilityId)
			end
			
			-- –ó–≤—É–∫ –æ–∫–æ–Ω—á–∞–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∞ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
			if self.soundService then
				self.soundService:playAbilityDeactivate()
			end
			
			self:_notifyEffectExpired(player, abilityId)
			print("AbilityService: –≠—Ñ—Ñ–µ–∫—Ç", abilityId, "–∏—Å—Ç–µ–∫ —É –∏–≥—Ä–æ–∫–∞", player.Name)
		end
	end
end

-- –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –∏–≥—Ä–æ–∫–∞
function AbilityService:removeAllEffects(player: Player): ()
	local playerState = self:getPlayerState(player)
	
	-- –£–¥–∞–ª—è–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã —á–µ—Ä–µ–∑ PlayerStatsService
	for abilityId, _ in pairs(playerState.activeEffects) do
		if PlayerStatsService then
			PlayerStatsService:removeEffect(player, abilityId)
		end
	end
	
	-- –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
	playerState.activeEffects = {}
	
	print("AbilityService: –£–¥–∞–ª–µ–Ω—ã –≤—Å–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –∏–≥—Ä–æ–∫–∞", player.Name)
end

-- –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π
function AbilityService:onAbilityActivated(callback: (player: Player, ability: Ability) -> ())
	table.insert(abilityActivatedCallbacks, callback)
end

-- –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∏—Å—Ç–µ—á–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
function AbilityService:onEffectExpired(callback: (player: Player, abilityId: string) -> ())
	table.insert(effectExpiredCallbacks, callback)
end

-- –ü–æ–ª—É—á–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—É—é –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å —É—á–µ—Ç–æ–º –±—É—Å—Ç–æ–≤
function AbilityService:getEffectiveDuration(player: Player, abilityId: string): number
	local ability = AbilityConfig.getAbilityById(abilityId)
	if not ability then
		return 0
	end
	
	local baseDuration = ability.baseDuration
	
	-- –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–µ–º–∏—É–º –±—É—Å—Ç
	if self:isPremiumPlayer(player) then
		baseDuration = baseDuration * CONFIG.PREMIUM_DURATION_MULTIPLIER
	end
	
	-- TODO: –î–æ–±–∞–≤–∏—Ç—å –±—É—Å—Ç—ã –æ—Ç —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–π –¥–≤–∏–∂–µ–Ω–∏—è
	
	return baseDuration
end

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∏–≥—Ä–æ–∫ –ø—Ä–µ–º–∏—É–º (–∑–∞–≥–ª—É—à–∫–∞)
function AbilityService:isPremiumPlayer(player: Player): boolean
	-- TODO: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å –Ω–∞—Å—Ç–æ—è—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π –ø—Ä–µ–º–∏—É–º–∞
	-- –ü–æ–∫–∞ —á—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –∏–º–µ–Ω–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
	return string.find(player.Name, "Premium") ~= nil
end

-- –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã

-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä–æ–∫–∞
function AbilityService:_initializePlayerState(player: Player)
	playerStates[player] = {
		ownedAbilities = {},
		activeEffects = {},
		cooldowns = {},
	}
	
	-- TODO: –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ DataStore
	-- –ò–≥—Ä–æ–∫ –Ω–∞—á–∏–Ω–∞–µ—Ç –ë–ï–ó —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π - –≤—Å–µ –Ω—É–∂–Ω–æ –ø–æ–∫—É–ø–∞—Ç—å –≤ –º–∞–≥–∞–∑–∏–Ω–µ
	-- –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å —Å–∏—Å—Ç–µ–º–æ–π –º–∞–≥–∞–∑–∏–Ω–∞
	
	print("AbilityService: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∏–≥—Ä–æ–∫–∞", player.Name, "- –±–µ–∑ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π (–Ω—É–∂–Ω–æ –ø–æ–∫—É–ø–∞—Ç—å)")
end

-- –û—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä–æ–∫–∞
function AbilityService:_cleanupPlayerState(player: Player)
	-- TODO: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ DataStore
	playerStates[player] = nil
	print("AbilityService: –û—á–∏—â–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∏–≥—Ä–æ–∫–∞", player.Name)
end

-- –ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
function AbilityService:_startEffectUpdateLoop()
	local lastUpdate = 0
	
	RunService.Heartbeat:Connect(function()
		local currentTime = tick()
		
		-- –û–±–Ω–æ–≤–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã –∫–∞–∂–¥—ã–µ 0.1 —Å–µ–∫—É–Ω–¥—ã
		if currentTime - lastUpdate >= CONFIG.EFFECT_UPDATE_INTERVAL then
			lastUpdate = currentTime
			
			for player, _ in pairs(playerStates) do
				if player.Parent then -- –ò–≥—Ä–æ–∫ –≤—Å–µ –µ—â–µ –≤ –∏–≥—Ä–µ
					self:clearExpiredEffects(player)
				end
			end
		end
	end)
end

-- –£–≤–µ–¥–æ–º–∏—Ç—å –æ–± –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
function AbilityService:_notifyAbilityActivated(player: Player, ability: Ability)
	for _, callback in ipairs(abilityActivatedCallbacks) do
		callback(player, ability)
	end
end

-- –£–≤–µ–¥–æ–º–∏—Ç—å –æ–± –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —ç—Ñ—Ñ–µ–∫—Ç–∞
function AbilityService:_notifyEffectExpired(player: Player, abilityId: string)
	for _, callback in ipairs(effectExpiredCallbacks) do
		callback(player, abilityId)
	end
end

return AbilityService
